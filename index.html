<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="appTitle">Инспектор Больничных Систем</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .page { display: none; }
        .page.active { display: block; }
        .rating-btn-group .selected { background-color: #4f46e5; color: white; }
        .rating-btn-group .selected.rating-1 { background-color: #ef4444; }
        .rating-btn-group .selected.rating-2 { background-color: #f97316; }
        .rating-btn-group .selected.rating-3 { background-color: #eab308; }
        .rating-btn-group .selected.rating-4 { background-color: #22c55e; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading-overlay" class="fixed inset-0 bg-white/80 z-50 flex-col items-center justify-center hidden">
        <div class="loader"></div>
        <p id="loadingText" class="mt-4 text-gray-600 font-medium" data-lang-key="loadingText"></p>
    </div>

    <div id="setupPage" class="page active p-4 md:p-8 max-w-lg mx-auto">
        <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="text-center mb-6">
                <i class="fas fa-hospital-user fa-3x text-indigo-500"></i>
                <h1 class="text-2xl font-bold text-gray-800 mt-2" data-lang-key="setupTitle"></h1>
                <p class="text-gray-500" data-lang-key="setupSubtitle"></p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label for="inspectorName" class="block text-sm font-medium text-gray-700" data-lang-key="inspectorLabel"></label>
                    <input type="text" id="inspectorName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="department" class="block text-sm font-medium text-gray-700" data-lang-key="departmentLabel"></label>
                    <input type="text" id="department" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>

            <div class="mt-8 space-y-3">
                <button id="startInspectionBtn" class="w-full bg-indigo-600 text-white py-3 px-4 border border-transparent rounded-md shadow-sm text-base font-medium hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" data-lang-key="startInspectionBtn"></button>
                <button id="viewReportsFromHomeBtn" class="w-full bg-gray-500 text-white py-2 px-4 rounded-md shadow-sm text-base font-medium hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400" data-lang-key="viewReportsBtn"></button>
                <button id="showRatingHintBtn" class="w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-md shadow-sm text-base font-medium hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400" data-lang-key="ratingHintBtn"></button>
            </div>
        </div>
    </div>

    <div id="inspectionPage" class="page p-4 md:p-8 max-w-4xl mx-auto">
         <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <div>
                    <h2 class="text-xl font-bold text-gray-800" data-lang-key="roomCheckTitle"></h2>
                    <p class="text-sm text-gray-500">
                        <span id="headerInspector"></span> - <span id="headerDepartment"></span>
                    </p>
                </div>
                <button id="viewReportBtn" class="bg-green-500 text-white py-2 px-4 rounded-md shadow-sm hover:bg-green-600">
                    <i class="fas fa-chart-line mr-2"></i><span data-lang-key="viewReportBtnShort"></span>
                </button>
            </div>
            
            <div id="roomSelectionBlock" class="mb-6">
                <label for="roomName" class="block text-sm font-medium text-gray-700" data-lang-key="roomNameLabel"></label>
                <div class="mt-1 flex rounded-md shadow-sm">
                    <input type="text" id="roomName" class="flex-1 block w-full min-w-0 rounded-none rounded-l-md px-3 py-2 border-gray-300 focus:ring-indigo-500 focus:border-indigo-500" data-lang-key="roomNamePlaceholder">
                    <button id="startRoomInspectionBtn" class="inline-flex items-center px-4 py-2 border border-l-0 border-indigo-600 bg-indigo-600 text-white rounded-r-md hover:bg-indigo-700" data-lang-key="startBtn"></button>
                </div>
            </div>
            
            <div id="systemsCheckBlock" class="hidden">
                <h3 class="text-lg font-semibold text-gray-700 mb-4"><span data-lang-key="roomLabel"></span> <span id="currentRoomName" class="text-indigo-600"></span></h3>
                <div id="systemsList" class="space-y-5"></div>
                
                <div class="mt-6 pt-4 border-t">
                     <label for="customSystemName" class="block text-sm font-medium text-gray-700" data-lang-key="addCustomSystemLabel"></label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <input type="text" id="customSystemName" class="flex-1 block w-full min-w-0 rounded-none rounded-l-md px-3 py-2 border-gray-300 focus:ring-indigo-500 focus:border-indigo-500" data-lang-key="customSystemPlaceholder">
                        <button id="addCustomSystemBtn" class="inline-flex items-center px-3 py-2 border border-l-0 border-gray-300 bg-gray-50 text-gray-700 hover:bg-gray-100 rounded-r-md" data-lang-key="addBtn"></button>
                    </div>
                </div>
                
                <div class="mt-8 flex justify-end">
                    <button id="completeRoomBtn" class="bg-indigo-600 text-white py-3 px-6 rounded-md shadow-sm hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed" data-lang-key="completeRoomBtn"></button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="reportPage" class="page p-4 md:p-8">
        <div class="bg-white p-6 rounded-xl shadow-md max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800" data-lang-key="reportTitle"></h1>
                    <p class="text-gray-500" data-lang-key="reportSubtitle"></p>
                </div>
                <div class="flex space-x-2">
                     <button id="exportCsvBtn" class="bg-blue-500 text-white py-2 px-4 rounded-md shadow-sm hover:bg-blue-600">
                        <i class="fas fa-file-csv mr-2"></i><span data-lang-key="exportCsvBtn"></span>
                    </button>
                    <button id="backToInspectionBtn" class="bg-gray-500 text-white py-2 px-4 rounded-md shadow-sm hover:bg-gray-600">
                        <span data-lang-key="backToInspectionBtn"></span>
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang-key="tableHDepartment"></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang-key="tableHRoom"></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang-key="tableHSystem"></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang-key="tableHRating"></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang-key="tableHComment"></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang-key="tableHInspector"></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang-key="tableHDate"></th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDTI7k9eI21wKVbsn8pm3cLf2XPWnZeITY",
            authDomain: "hospital-inspector-app.firebaseapp.com",
            projectId: "hospital-inspector-app",
            storageBucket: "hospital-inspector-app.appspot.com",
            messagingSenderId: "624165443618",
            appId: "1:624165443618:web:2b766c45adf75b2f28527b",
            measurementId: "G-QZPFMECY6L"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const translations = {
            'ru': {
                appTitle: "Инспектор Больничных Систем",
                loadingText: "Загрузка данных...",
                savingText: "Сохранение отчета...",
                setupTitle: "Инспекция Систем",
                setupSubtitle: "Начало новой проверки",
                inspectorLabel: "ФИО проверяющего",
                departmentLabel: "Отделение (впишите название)",
                startInspectionBtn: "Начать инспекцию",
                viewReportsBtn: "Посмотреть отчеты",
                ratingHintBtn: "Памятка по оценкам",
                roomCheckTitle: "Проверка комнаты",
                viewReportBtnShort: "Смотреть отчет",
                roomNameLabel: "Введите номер/название комнаты",
                roomNamePlaceholder: "Палата 101",
                startBtn: "Начать",
                roomLabel: "Комната:",
                addCustomSystemLabel: "Добавить нестандартную систему для проверки",
                customSystemPlaceholder: "Например, кондиционер",
                addBtn: "Добавить",
                completeRoomBtn: "Завершить проверку комнаты",
                reportTitle: "Отчет о неисправностях",
                reportSubtitle: "Системы с оценкой 1 или 2, требующие внимания.",
                exportCsvBtn: "Экспорт в CSV",
                backToInspectionBtn: "Назад к инспекции",
                tableHDepartment: "Отделение",
                tableHRoom: "Комната",
                tableHSystem: "Система",
                tableHRating: "Оценка",
                tableHComment: "Комментарий",
                tableHInspector: "Проверяющий",
                tableHDate: "Дата",
                alertEnterInspectorAndDepartment: "Пожалуйста, введите имя проверяющего и название отделения.",
                alertEnterRoomName: "Пожалуйста, введите номер или название комнаты.",
                alertRoomReportSaved: (room) => `Отчет по комнате "${room}" успешно сохранен!`,
                alertRoomReportError: "Произошла ошибка при сохранении отчета.",
                alertReportsLoadError: "Не удалось загрузить отчеты.",
                noIssuesFound: "Неисправностей не найдено.",
                headerInspectorLabel: "Проверяющий:",
                headerDepartmentLabel: "Отделение:",
                commentPlaceholder: "Добавить комментарий (необязательно)",
                ratingExplanation: "ПАМЯТКА ПО ОЦЕНКАМ:\n\n4 - Хорошее состояние\n3 - Удовлетворительно\n2 - Требуется ремонт/восстановление\n1 - Требуется замена/капитальный ремонт",
                standardSystems: ["Окна", "Двери", "Стены и потолок", "Кровати", "Электрооборудование", "Душ", "Туалет", "Краны", "Шкафы", "Тумбочки"]
            }
        };

        // ИСПРАВЛЕНО: Возвращаем переменную lang и упрощаем логику
        const lang = 'ru';
        const T = translations[lang];

        document.addEventListener('DOMContentLoaded', () => {
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-lang-key]').forEach(elem => {
                const key = elem.getAttribute('data-lang-key');
                if (T[key]) {
                    if (elem.placeholder !== undefined) {
                        elem.placeholder = T[key];
                    } else {
                        elem.textContent = T[key];
                    }
                }
            });
        });

        let state = { inspector: '', department: '', currentRoom: '', currentChecklist: new Map(), allReports: [] };
        const standardSystems = T.standardSystems;

        const pages = { setup: document.getElementById('setupPage'), inspection: document.getElementById('inspectionPage'), report: document.getElementById('reportPage'), loading: document.getElementById('loading-overlay') };
        const loadingText = document.getElementById('loadingText');
        const inspectorNameInput = document.getElementById('inspectorName');
        const departmentInput = document.getElementById('department');
        const startInspectionBtn = document.getElementById('startInspectionBtn');
        const viewReportsFromHomeBtn = document.getElementById('viewReportsFromHomeBtn');
        const showRatingHintBtn = document.getElementById('showRatingHintBtn');
        const roomNameInput = document.getElementById('roomName');
        const startRoomInspectionBtn = document.getElementById('startRoomInspectionBtn');
        const systemsCheckBlock = document.getElementById('systemsCheckBlock');
        const roomSelectionBlock = document.getElementById('roomSelectionBlock');
        const systemsList = document.getElementById('systemsList');
        const currentRoomNameSpan = document.getElementById('currentRoomName');
        const completeRoomBtn = document.getElementById('completeRoomBtn');
        const viewReportBtn = document.getElementById('viewReportBtn');
        const backToInspectionBtn = document.getElementById('backToInspectionBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const reportTableBody = document.getElementById('reportTableBody');
        const customSystemNameInput = document.getElementById('customSystemName');
        const addCustomSystemBtn = document.getElementById('addCustomSystemBtn');

        function showLoader(text = T.loadingText) {
            loadingText.textContent = text;
            pages.loading.classList.remove('hidden');
            pages.loading.classList.add('flex');
        }
        function hideLoader() {
            pages.loading.classList.add('hidden');
            pages.loading.classList.remove('flex');
        }
        function navigate(pageName) {
            Object.values(pages).forEach(page => page.classList.remove('active'));
            if (pages[pageName]) pages[pageName].classList.add('active');
        }

        startInspectionBtn.addEventListener('click', () => {
            const inspector = inspectorNameInput.value.trim();
            const department = departmentInput.value.trim();
            if (!inspector || !department) {
                alert(T.alertEnterInspectorAndDepartment);
                return;
            }
            state.inspector = inspector;
            state.department = department;
            document.getElementById('headerInspector').textContent = `${T.headerInspectorLabel} ${inspector}`;
            document.getElementById('headerDepartment').textContent = `${T.headerDepartmentLabel} ${department}`;
            navigate('inspection');
        });

        viewReportsFromHomeBtn.addEventListener('click', () => {
            subscribeToReports();
            navigate('report');
        });

        showRatingHintBtn.addEventListener('click', () => {
            alert(T.ratingExplanation);
        });

        startRoomInspectionBtn.addEventListener('click', () => {
            const room = roomNameInput.value.trim();
            if (!room) {
                alert(T.alertEnterRoomName);
                return;
            }
            state.currentRoom = room;
            currentRoomNameSpan.textContent = room;
            renderSystemsList(standardSystems);
            roomSelectionBlock.classList.add('hidden');
            systemsCheckBlock.classList.remove('hidden');
            roomNameInput.value = '';
            checkIfRoomComplete();
        });

        function renderSystemsList(systems) {
            systemsList.innerHTML = '';
            state.currentChecklist.clear();
            systems.forEach(system => {
                state.currentChecklist.set(system, { rating: 0, comment: '' });
                systemsList.appendChild(createSystemChecklistItem(system));
            });
            checkIfRoomComplete();
        }

        function createSystemChecklistItem(systemName) {
            const div = document.createElement('div');
            div.className = 'p-4 border rounded-lg bg-gray-50';
            div.dataset.system = systemName;
            div.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                    <h4 class="text-md font-semibold text-gray-800 mb-2 sm:mb-0">${systemName}</h4>
                    <div class="flex-shrink-0 rating-btn-group flex space-x-1">
                        ${[1,2,3,4].map(n => `<button data-rating="${n}" class="rating-btn rating-${n} w-10 h-10 rounded-full font-bold border transition-colors">${n}</button>`).join('')}
                    </div>
                </div>
                <div class="mt-3">
                    <textarea class="comment-input w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="${T.commentPlaceholder}"></textarea>
                </div>
            `;
            const ratingButtons = div.querySelectorAll('.rating-btn');
            ratingButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    ratingButtons.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    state.currentChecklist.get(systemName).rating = parseInt(btn.dataset.rating, 10);
                    checkIfRoomComplete();
                });
            });
            div.querySelector('.comment-input').addEventListener('input', (e) => {
                state.currentChecklist.get(systemName).comment = e.target.value;
            });
            return div;
        }

        function checkIfRoomComplete() {
            completeRoomBtn.disabled = ![...state.currentChecklist.values()].every(v => v.rating !== 0);
        }

        addCustomSystemBtn.addEventListener('click', () => {
            const customName = customSystemNameInput.value.trim();
            if (customName && !state.currentChecklist.has(customName)) {
                state.currentChecklist.set(customName, { rating: 0, comment: '' });
                systemsList.appendChild(createSystemChecklistItem(customName));
                customSystemNameInput.value = '';
                checkIfRoomComplete();
            }
        });
        
        completeRoomBtn.addEventListener('click', async () => {
            showLoader(T.savingText);
            const promises = Array.from(state.currentChecklist.entries()).map(([system, data]) => 
                addDoc(collection(db, "inspections"), {
                    inspector: state.inspector, department: state.department, room: state.currentRoom,
                    system: system, rating: data.rating, comment: data.comment,
                    createdAt: serverTimestamp()
                })
            );
            try {
                await Promise.all(promises);
                alert(T.alertRoomReportSaved(state.currentRoom));
                state.currentRoom = '';
                state.currentChecklist.clear();
                systemsCheckBlock.classList.add('hidden');
                roomSelectionBlock.classList.remove('hidden');
            } catch (error) {
                console.error("Ошибка при сохранении данных: ", error);
                alert(T.alertRoomReportError);
            } finally {
                hideLoader();
            }
        });
        
        let unsubscribe = null; 
        function subscribeToReports() {
            showLoader();
            if (unsubscribe) unsubscribe();
            // Возвращаем простой и надежный запрос
            const q = query(collection(db, "inspections"), where("rating", "in", [1, 2]), orderBy("createdAt", "desc"));
            unsubscribe = onSnapshot(q, (querySnapshot) => {
                state.allReports = [];
                querySnapshot.forEach((doc) => state.allReports.push({ id: doc.id, ...doc.data() }));
                renderReportTable(state.allReports);
                hideLoader();
            }, (error) => {
                console.error("Ошибка при получении отчетов: ", error);
                alert(T.alertReportsLoadError);
                hideLoader();
            });
        }
        
        function renderReportTable(reports) {
            reportTableBody.innerHTML = '';
            if (reports.length === 0) {
                reportTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-gray-500">${T.noIssuesFound}</td></tr>`;
                return;
            }
            reports.forEach(report => {
                const tr = document.createElement('tr');
                const ratingColor = report.rating === 1 ? 'bg-red-100 text-red-800' : 'bg-orange-100 text-orange-800';
                const date = report.createdAt ? report.createdAt.toDate().toLocaleString(lang) : 'N/A';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.department}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${report.room}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${report.system}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${ratingColor}">${report.rating}</span></td>
                    <td class="px-6 py-4 text-sm text-gray-500" style="max-width: 200px; white-space: normal;">${report.comment}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.inspector}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
                `;
                reportTableBody.appendChild(tr);
            });
        }

        exportCsvBtn.addEventListener('click', () => {
            if (state.allReports.length === 0) {
                alert(T.alertNoDataToExport);
                return;
            }
            const headers = [T.tableHDepartment, T.tableHRoom, T.tableHSystem, T.tableHRating, T.tableHComment, T.tableHInspector, T.tableHDate];
            const rows = state.allReports.map(report => {
                const date = report.createdAt ? report.createdAt.toDate().toLocaleString(lang) : 'N/A';
                const sanitizedComment = `"${(report.comment || '').replace(/"/g, '""')}"`;
                return [report.department, report.room, report.system, report.rating, sanitizedComment, report.inspector, date].join(";");
            });
            let csvContent = "\uFEFF" + headers.join(";") + "\r\n" + rows.join("\r\n");
            const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `report_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        viewReportBtn.addEventListener('click', () => subscribeToReports());
        backToInspectionBtn.addEventListener('click', () => navigate('inspection'));

        navigate('setup');
    </script>

</body>
</html>
